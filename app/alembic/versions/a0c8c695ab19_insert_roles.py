"""insert Roles

Revision ID: a0c8c695ab19
Revises: 747d59121c3a
Create Date: 2024-12-17 11:24:46.462773

"""
from typing import Sequence,Union
from alembic import op
from sqlmodel import Session
import sqlalchemy as sa
from datetime import datetime
from app.models.rol import Rol
from app.models.user import User
from app.models.associations.user_rol import UserRolLink
from app.controllers.userController import get_password_hash
from passlib.context import CryptContext
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = 'a0c8c695ab19'
down_revision: Union[str, None] = '747d59121c3a'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade():
    # Obtener conexión
    bind = op.get_bind()
    session = Session(bind=bind)

    try:
        # Verificar si ya existen roles
        if not session.exec(sa.select(Rol).where(Rol.rol == "Super_admin")).first():
            # Crear roles
            admin_rol = Rol(rol="Super_admin")
            guest_rol = Rol(rol="Guest")
            
            session.add_all([admin_rol, guest_rol])
            session.commit()

            # Crear usuario admin
            hashed_pwd = get_password_hash("Super_admin")
            admin_user = User(
                email="admin@example.com",
                password=hashed_pwd,
                is_active=True
            )
            session.add(admin_user)
            session.commit()

            # Asignar rol
            user_rol = UserRolLink(
                user_id=admin_user.id,
                rol_id=admin_rol.id
            )
            session.add(user_rol)
            session.commit()

    except Exception as e:
        session.rollback()
        raise e
    finally:
        session.close()

    # ### commands auto generated by Alembic - please adjust! ###
    
    # connection = op.get_bind()
    # empty_database = connection.execute(sa.text("SELECT count(*) FROM information_schema.tables WHERE table_schema = 'public'")).scalar() == 0
    
    # if empty_database:
    #     # Crear roles predeterminados si la base de datos está vacía
    #     default_roles = [
    #         "Admin",
    #         "SuperAdmin",
    #         "User"
    #     ]

        
    #     for role_data in default_roles:
    #         new_role = Rol(name=role_data)
    #         op.
    #         op.bulk_insert(op.get_bind(), new_role, [
    #             {"name": role_data["name"]}
    #         ])
    # # # ### end Alembic commands ###


def downgrade():
    bind = op.get_bind()
    session = Session(bind=bind)

    try:
        # Eliminar en orden inverso
        session.exec(sa.delete(UserRolLink))
        session.exec(sa.delete(User).where(User.email == "admin@example.com"))
        session.exec(sa.delete(Rol).where(Rol.rol.in_(["Super_admin", "Guest"])))
        session.commit()
    except Exception as e:
        session.rollback()
        raise e
    finally:
        session.close()